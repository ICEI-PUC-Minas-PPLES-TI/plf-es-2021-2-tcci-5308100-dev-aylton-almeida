FROM python:3.9

WORKDIR /app

# Install dependencies
COPY requirements.txt .
RUN pip install -r requirements.txt

ARG FLASK_ENV='production'
ARG FLASK_APP='main.py'
ARG DB_SERVER_URL
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_DEFAULT_REGION
ARG S3_BUCKET_PATH
ARG COGNITO_POOL_ID
ARG COGNITO_CLIENT_ID
ARG COGNITO_CLIENT_SECRET
ARG COGNITO_TOKEN_ENDPOINT
ARG COGNITO_TOKEN_SCOPE
ARG MQ_EXCHANGE
ARG MQ_URL
ARG SERVICES_BASE_API

ENV FLASK_ENV $FLASK_ENV
ENV FLASK_APP $FLASK_APP
ENV DB_SERVER_URL $DB_SERVER_URL
ENV AWS_ACCESS_KEY_ID $AWS_ACCESS_KEY_ID
ENV AWS_SECRET_ACCESS_KEY $AWS_SECRET_ACCESS_KEY
ENV AWS_DEFAULT_REGION $AWS_DEFAULT_REGION
ENV S3_BUCKET_PATH $S3_BUCKET_PATH
ENV COGNITO_POOL_ID $COGNITO_POOL_ID
ENV COGNITO_CLIENT_ID $COGNITO_CLIENT_ID
ENV COGNITO_CLIENT_SECRET $COGNITO_CLIENT_SECRET
ENV COGNITO_TOKEN_ENDPOINT $COGNITO_TOKEN_ENDPOINT
ENV COGNITO_TOKEN_SCOPE $COGNITO_TOKEN_SCOPE
ENV MQ_EXCHANGE $MQ_EXCHANGE
ENV MQ_URL $MQ_URL
ENV SERVICES_BASE_API $SERVICES_BASE_API

# Run the application
COPY . .
CMD gunicorn -k gevent -t 300 -b :5000 main:app
